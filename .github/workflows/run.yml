name: Run

on: push

jobs:
  create-runner:
    runs-on: ubuntu-latest
    outputs:
      label: ${{ steps.create-runner.outputs.label }}
    steps:
      - id: create-runner
        uses: related-sciences/gce-github-runner@v0.14
        with:
          token: ${{ secrets.GH_SA_TOKEN }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          image_project: ubuntu-os-cloud
          image_family: ubuntu-2004-lts
  test:
    needs: create-runner
    runs-on: ${{ needs.create-runner.outputs.label }}
    steps:
      - run: echo "This runs on the GCE VM"
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: local-archive
            source_path: test/sample-archive/
            min_lat: 40
            max_lat: 50
            min_lon: 5
            max_lon: 10
            limit_results: 5000
            geocode_precision: 8
            min_clusters: 2
            max_clusters: 10
            output_dir: output
          - name: gbif-snapshot
            source_path: gs://public-datasets-gbif/occurrence/2026-01-01/occurrence.parquet/
            min_lat: 25
            max_lat: 47
            min_lon: -87
            max_lon: -66
            limit_results: 5000
            geocode_precision: 4
            min_clusters: 2
            max_clusters: 15
            max_taxa: 10000
            min_geocode_presence: 0.02
            output_dir: output-gbif
    permissions:
      contents: "read"
      id-token: "write"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - uses: "google-github-actions/auth@v3"
        with:
          credentials_json: "${{ secrets.GCP_SERVICE_ACCOUNT }}"
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - name: Lint notebook
        if: matrix.name == 'local-archive'
        run: uv run marimo check notebook.py
      - name: Run and export notebook (${{ matrix.name }})
        run: |
          uv run marimo export html notebook.py -o ${{ matrix.output_dir }}/index.html --force -- \
            --no-stop \
            --geocode-precision=${{ matrix.geocode_precision }} \
            --min-clusters=${{ matrix.min_clusters }} \
            --max-clusters=${{ matrix.max_clusters }} \
            --log-file=/dev/stdout \
            --min-lat=${{ matrix.min_lat }} \
            --max-lat=${{ matrix.max_lat }} \
            --min-lon=${{ matrix.min_lon }} \
            --max-lon=${{ matrix.max_lon }} \
            ${{ matrix.limit_results != null && format('--limit-results={0}', matrix.limit_results) || '' }} \
            ${{ matrix.max_taxa != null && format('--max-taxa={0}', matrix.max_taxa) || '' }} \
            ${{ matrix.min_geocode_presence != null && format('--min-geocode-presence={0}', matrix.min_geocode_presence) || '' }} \
            --parquet-source-path="${{ matrix.source_path }}"
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install frontend dependencies and build
        working-directory: frontend
        run: |
          npm install
          npm run build
      - name: Move frontend to output
        run: mv frontend/dist ${{ matrix.output_dir }}/frontend
      - name: Copy aggregations.json
        run: cp frontend/aggregations.json ${{ matrix.output_dir }}/frontend/aggregations.json
      - name: üì¶ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ matrix.output_dir }}/
          name: github-pages-${{ matrix.name }}

  # deploy:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   environment:
  #     name: github-pages
  #     url: ${{ steps.deployment.outputs.page_url }}

  #   permissions:
  #     pages: write
  #     id-token: write

  #   steps:
  #     - name: üåê Deploy to GitHub Pages
  #       id: deployment
  #       uses: actions/deploy-pages@v4
  #       with:
  #         artifact_name: github-pages-gbif-snapshot
